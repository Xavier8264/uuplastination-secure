# ====================================================================
# UU Plastination Secure - Environment Configuration
# ====================================================================
# Copy this file to .env and adjust values for your setup

# --- Camera Configuration ---
# Raspberry Pi Camera port (0 for CAM0, 1 for CAM1, etc.)
CAMERA_NUM=0

# Camera resolution
CAMERA_WIDTH=1920
CAMERA_HEIGHT=1080

# Camera frame rate
CAMERA_FPS=30

# --- Valve/Stepper Motor GPIO Configuration ---
# GPIO pin numbers use BCM numbering (not physical pin numbers)
# Common wiring example for A4988/DRV8825 stepper drivers:
#   - STEP signal: GPIO 23 (pin 16)
#   - DIR signal:  GPIO 24 (pin 18)
#   - ENABLE:      GPIO 18 (pin 12)

# STEP pin - sends pulses to move the motor
VALVE_PIN_STEP=23

# DIR pin - controls direction (HIGH=forward, LOW=reverse)
VALVE_PIN_DIR=24

# ENABLE pin - enables/disables motor (set to -1 if not used)
VALVE_PIN_ENABLE=18

# Invert enable logic (1 = active-low, 0 = active-high)
# Most drivers like A4988/DRV8825 use active-low (1)
STEPPER_INVERT_ENABLE=1

# Motor configuration
STEPPER_STEPS_PER_REV=200
STEPPER_DEFAULT_RPM=60

# Steps to move when using open/close buttons
STEPPER_OPEN_STEPS=200
STEPPER_CLOSE_STEPS=-200

# --- System Monitoring ---
# Service names to monitor (systemd)
SERVICE_CAMERA=camera-stream.service
SERVICE_STEPPER=valve-control.service

# Ports to check
PORT_RTSP=8554
PORT_API=8000

# --- LiveKit / WebRTC Configuration ---
# Public base URL for LiveKit signaling (reachable by browsers). If using Cloudflare Tunnel,
# set to the HTTPS URL you expose (e.g. https://www.uuplastination.com/secure/livekit or a subdomain).
LIVEKIT_HOST=https://www.uuplastination.com/secure/livekit

# API key / secret for LiveKit (generate with livekit-server or docker logs on first run if absent)
LIVEKIT_API_KEY=LK_API_KEY_PLACEHOLDER
LIVEKIT_API_SECRET=LK_API_SECRET_PLACEHOLDER

# ICE servers list (comma-separated). You can start with just TURN; STUN is optional.
# Example: stun:stun.l.google.com:19302,turns:turn.uuplastination.com:5349?transport=tcp
LIVEKIT_ICE_SERVERS=turns:turn.uuplastination.com:5349?transport=tcp

# Optionally disable WebRTC on the frontend (force MJPEG fallback)
# 0 = enabled (default), 1 = disabled
WEBRTC_DISABLE=0

# TURN / coturn configuration. TURN must be reachable directly (Cloudflare does not proxy UDP).
# If you cannot expose UDP 3478 due to tunnel limitations, ensure TCP/TLS (5349) is reachable.
TURN_REALM=uuplastination.com
TURN_STATIC_SECRET=REPLACE_WITH_RANDOM_32_CHAR_HEX
# External public IP of the host (or leave blank if auto-detected). Required when behind NAT.
TURN_EXTERNAL_IP=YOUR.PUBLIC.IP.ADDRESS
# Directory containing TLS certs (fullchain.pem, privkey.pem) for coturn.
TURN_CERT_DIR=/etc/letsencrypt/live/uuplastination.com

# --- Security & Hardening Recommendations ---
# 1. Generate TURN_STATIC_SECRET (32+ random hex chars):
#    python -c "import secrets; print(secrets.token_hex(32))"
# 2. Use a dedicated subdomain for LiveKit (e.g. livekit.uuplastination.com) if possible.
# 3. Ensure HTTPS termination either at nginx or Cloudflare; avoid plain ws:// in production.
# 4. Restrict .env file permissions:
#    chmod 600 .env
# 5. Rotate API key/secret periodically (every 90 days or upon personnel changes).
# 6. If using Cloudflare Tunnel, DO NOT tunnel coturn UDP. Provide direct DNS A record for TURN host.
# 7. Consider adding a second TURN server region for geographic redundancy.

# --- Operational Flags ---
# Enable verbose logging for debugging (set to 1 temporarily only):
DEBUG_VERBOSE=0

# --- Publisher Settings (RTMP) ---
# Path to ingress key file (written by init_ingress.py) for RTMP publisher script.
INGRESS_KEY_PATH=webrtc/ingress_key.txt
# Force libcamera pixel format (leave blank for default): e.g. YUV420
LIBCAMERA_PIXEL_FORMAT=
# Optional bitrate target for ffmpeg encoding (in kbps):
FFMPEG_VIDEO_BITRATE=2500

# --- Health Probe/Retry Settings ---
# Max backoff (ms) for WebRTC retry loop on the frontend.
WEBRTC_MAX_BACKOFF_MS=20000
# Initial backoff (ms):
WEBRTC_INITIAL_BACKOFF_MS=2000

# --- Future Extensions ---
# AI_DETECTION_ENABLE=0
# AI_DETECTION_MODEL_PATH=models/detector.onnx


# ====================================================================
# GPIO PIN REFERENCE (Raspberry Pi BCM numbering)
# ====================================================================
# You can use any available GPIO pins. Common choices:
#
# BCM GPIO | Physical Pin | Common Use
# ---------|--------------|------------------
#    2     |      3       | I2C SDA
#    3     |      5       | I2C SCL
#    4     |      7       | General Purpose
#   17     |     11       | General Purpose
#   27     |     13       | General Purpose
#   22     |     15       | General Purpose
#   23     |     16       | STEP (recommended)
#   24     |     18       | DIR (recommended)
#   25     |     22       | General Purpose
#   18     |     12       | ENABLE (PWM capable)
#   GND    |   6,9,14,20,25,30,34,39 | Ground
#
# ====================================================================
# WIRING EXAMPLE for A4988/DRV8825 Stepper Driver
# ====================================================================
# Raspberry Pi          ->   Stepper Driver
# GPIO 23 (Pin 16)      ->   STEP
# GPIO 24 (Pin 18)      ->   DIR
# GPIO 18 (Pin 12)      ->   ENABLE (or ENÌ… for active-low)
# GND (any GND pin)     ->   GND
# 
# Stepper Driver        ->   Power Supply
# VMOT                  ->   12V-24V (depends on motor)
# GND                   ->   Power supply GND
# 
# Stepper Driver        ->   Stepper Motor
# 1A, 1B, 2A, 2B        ->   Motor coil wires (check motor datasheet)
# ====================================================================
