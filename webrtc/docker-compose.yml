version: "3.8"

# LiveKit signaling + Ingress + coturn
# Exposes:
# - LiveKit Server (HTTP/WS): 7880 (use behind HTTPS proxy or Cloudflare Tunnel)
# - LiveKit Server (HTTPS/WSS optional): 7443 (if you terminate TLS here)
# - Ingress RTMP: 1935 (internal only unless you expose)
# - coturn: 3478/udp (TURN), 5349/tcp (TURNS). You should expose TURNS (5349) publicly or 443 if you bind there.

services:
  livekit:
    image: livekit/livekit-server:latest
    container_name: livekit
    restart: unless-stopped
    env_file:
      - ../.env
    environment:
      LIVEKIT_LISTEN_WS: ":7880"
      LIVEKIT_LISTEN_HTTP: ":7880"
      # LiveKit expects "key: secret" format with colon and space
      LIVEKIT_KEYS: "devkey: devsecret"
      LIVEKIT_PORT_RANGE_START: "50000"
      LIVEKIT_PORT_RANGE_END: "50050"
      LIVEKIT_LOG_LEVEL: "info"
      LIVEKIT_USE_EXTERNAL_IP: "true"
    network_mode: host
    # If you cannot use host networking, map ports explicitly instead:
    # ports:
    #   - "7880:7880"   # HTTP/WS signaling (proxy to HTTPS)
    #   - "50000-50050:50000-50050/udp"  # UDP media when relayed by SFU

  ingress:
    image: livekit/ingress:latest
    container_name: livekit-ingress
    restart: unless-stopped
    environment:
      INGRESS_LIVEKIT_URL: "ws://127.0.0.1:7880"
      INGRESS_API_KEY: "devkey"
      INGRESS_API_SECRET: "devsecret"
      INGRESS_LOG_LEVEL: "info"
      INGRESS_RTMP_PORT: "1935"
      INGRESS_HTTP_RELAY_PORT: "9090"
    network_mode: host
    # If not using host networking:
    # ports:
    #   - "1935:1935" # RTMP
    #   - "8080:8080" # HTTP control

  coturn:
    image: instrumentisto/coturn:4.5
    container_name: coturn
    restart: unless-stopped
    env_file:
      - ../.env
    command: >-
      -n --log-file=stdout
      --realm=${TURN_REALM}
      --cert=/certs/fullchain.pem
      --pkey=/certs/privkey.pem
      --no-cli
      --no-tlsv1 --no-tlsv1_1
      --cipher-list="TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256"
      --use-auth-secret
      --static-auth-secret=${TURN_STATIC_SECRET}
      --user-quota=12 --total-quota=1200
      --stale-nonce=600
      --fingerprint
      --no-multicast-peers
      --min-port=30000 --max-port=30050
      --external-ip=${TURN_EXTERNAL_IP}
      --listening-port=3478
      --tls-listening-port=5349
    network_mode: host
    volumes:
      - type: bind
        source: ${TURN_CERT_DIR}
        target: /certs
    # If you cannot use host networking:
    # ports:
    #   - "3478:3478/udp"
    #   - "5349:5349/tcp"

# Notes:
# - This compose uses host networking for lowest latency and to avoid NAT issues.
# - Provide LIVEKIT_HOST (e.g., https://livekit.example.com) and TURN settings in .env.
# - Ensure DNS for livekit and turn hostnames resolve publicly to your machine, and ports are reachable.
